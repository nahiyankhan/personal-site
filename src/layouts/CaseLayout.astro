---
import "@fontsource-variable/inter";
import "@fontsource-variable/jetbrains-mono";
import "@fontsource-variable/space-grotesk";
import "@fontsource/rubik-mono-one";
import { ViewTransitions } from "astro:transitions";
import BaseHead from "@/components/BaseHead.astro";
import ThemeProvider from "@/components/ThemeProvider.astro";
import { siteConfig } from "@/site-config";
import type { SiteMeta } from "@/types";

interface Props {
	meta: SiteMeta;
}

const {
	meta: { articleDate, description = siteConfig.description, ogImage, title },
} = Astro.props;
---

<html lang={siteConfig.lang}>
	<head>
		<BaseHead articleDate={articleDate} description={description} ogImage={ogImage} title={title} />
		<ViewTransitions />
	</head>
	<body class="h-dvh overflow-hidden font-sans text-base font-extralight leading-8 tracking-wide">
		<ThemeProvider />

		<header
			class="z-100 pointer-events-none fixed left-0 right-0 top-0 flex items-center justify-between p-4 sm:p-8"
		>
			<a
				href="/#forge"
				class="pointer-events-auto inline-flex items-center gap-2 text-sm tracking-wider text-current no-underline opacity-50 transition-opacity duration-200 hover:opacity-100"
			>
				<span>&larr;</span>
				<span>back</span>
			</a>
			<div class="pointer-events-auto flex items-center gap-4">
				<div class="text-xs tracking-widest opacity-30" id="section-indicator">01</div>
				<button
					class="cursor-pointer border-none bg-transparent p-1 text-current opacity-30 transition-opacity duration-200 hover:opacity-100"
					id="minimap-toggle"
					aria-label="Toggle minimap"
				>
					<svg
						width="16"
						height="16"
						viewBox="0 0 16 16"
						fill="none"
						stroke="currentColor"
						stroke-width="1.5"
					>
						<rect x="1" y="1" width="5" height="5" rx="1"></rect>
						<rect x="10" y="1" width="5" height="5" rx="1"></rect>
						<rect x="1" y="10" width="5" height="5" rx="1"></rect>
						<rect x="10" y="10" width="5" height="5" rx="1"></rect>
					</svg>
				</button>
			</div>
		</header>

		<aside
			class="minimap-sidebar z-90 fixed bottom-0 right-0 top-[4.5rem] w-[120px] translate-x-full overflow-y-auto pb-8 backdrop-blur-md transition-transform duration-300 sm:top-24"
			id="minimap-sidebar"
		>
			<div class="flex flex-col" id="minimap-slides"></div>
		</aside>

		<main class="case-container snap-y snap-mandatory h-dvh overflow-y-scroll" id="case-container">
			<slot />
		</main>
	</body>
</html>

<style is:global>
	/* CSS Variables */
	:root {
		--slate-0: 0deg 0% 100%;
		--slate-10: 233deg 100% 96%;
		--slate-20: 233deg 28% 81%;
		--slate-30: 233deg 22% 41%;
		--slate-40: 250deg 11% 26%;
		--slate-50: 250deg 9% 17%;
		--slate-60: 247deg 8% 12%;
	}

	:root[data-theme="light"] {
		--theme-bg: 42deg 17% 80%;
		--theme-bg-inverse: var(--slate-60);
		--theme-text: var(--slate-60);
		--border-divider: var(--slate-60);
	}

	:root[data-theme="dark"] {
		--theme-bg: var(--slate-60);
		--theme-bg-inverse: 42deg 17% 80%;
		--theme-text: 42deg 17% 80%;
		--border-divider: 42deg 17% 80%;
	}

	/* Variable-dependent styles */
	body {
		background: hsl(var(--theme-bg));
		color: hsl(var(--theme-text));
	}

	.minimap-sidebar {
		background: hsl(var(--theme-bg) / 0.95);
		scrollbar-width: none;
		border-radius: 0.75rem 0 0 0.75rem;
		overflow: hidden;
	}

	.minimap-sidebar::-webkit-scrollbar {
		display: none;
	}

	.minimap-sidebar.open {
		transform: translateX(0);
	}

	.minimap-item {
		border-color: hsl(var(--border-divider) / 0.1);
		border-left: 1px solid hsl(var(--border-divider) / 0.1);
	}

	.minimap-item:first-child {
		border-radius: 0.75rem 0 0 0;
	}

	.minimap-item:last-child {
		border-radius: 0 0 0 0.75rem;
	}

	.minimap-item > div {
		opacity: 0.4;
	}

	.minimap-item:hover {
		opacity: 1 !important;
		background: hsl(var(--theme-text));
		color: black;
	}

	.minimap-item:hover > div {
		color: black;
		opacity: 1;
	}

	.minimap-item.active > div {
		color: white;
		opacity: 1;
	}

	.case-container {
		scrollbar-width: none;
	}

	.case-container::-webkit-scrollbar {
		display: none;
	}

	.case-container section {
		min-height: 100dvh;
		scroll-snap-align: start;
		scroll-snap-stop: always;
		display: flex;
		flex-direction: column;
		justify-content: center;
		padding: 5rem 1rem 3rem;
		border-bottom: 1px solid hsl(var(--border-divider) / 0.1);
	}

	@media (min-width: 640px) {
		.case-container section {
			padding: 6rem 2rem 4rem;
		}
	}

	@media (min-width: 1024px) {
		.case-container section {
			padding: 6rem 4rem 4rem;
		}
	}
</style>

<script>
	function initCaseScroll() {
		const container = document.getElementById("case-container");
		const indicator = document.getElementById("section-indicator");
		const sections = container?.querySelectorAll("section");
		const minimapToggle = document.getElementById("minimap-toggle");
		const minimapSidebar = document.getElementById("minimap-sidebar");
		const minimapSlides = document.getElementById("minimap-slides");

		if (!container || !indicator || !sections) return;

		let currentIndex = 0;
		const thumbs: HTMLElement[] = [];

		// Build minimap items
		if (minimapSlides) {
			minimapSlides.innerHTML = "";
			sections.forEach((section, i) => {
				const item = document.createElement("div");
				item.className =
					"minimap-item py-8 px-4 cursor-pointer border-t transition-all duration-200";
				if (i === 0) item.classList.add("active");
				if (i === sections.length - 1) item.classList.add("border-b");

				const title = section.getAttribute("data-title") || `Slide ${i + 1}`;

				item.innerHTML = `
					<div class="text-[0.625rem] leading-none pb-1 tracking-wider">${String(i + 1).padStart(2, "0")}</div>
					<div class="text-sm font-normal tracking-wide">${title}</div>
				`;

				item.addEventListener("click", () => {
					section.scrollIntoView({ behavior: "smooth" });
				});

				minimapSlides.appendChild(item);
				thumbs.push(item);
			});
		}

		// Toggle minimap
		minimapToggle?.addEventListener("click", () => {
			minimapSidebar?.classList.toggle("open");
		});

		// Close minimap when clicking outside
		document.addEventListener("click", (e) => {
			if (
				minimapSidebar?.classList.contains("open") &&
				!minimapSidebar.contains(e.target as Node) &&
				!minimapToggle?.contains(e.target as Node)
			) {
				minimapSidebar.classList.remove("open");
			}
		});

		// Track current section
		const observer = new IntersectionObserver(
			(entries) => {
				entries.forEach((entry) => {
					if (entry.isIntersecting) {
						const index = Array.from(sections).indexOf(entry.target as HTMLElement);
						currentIndex = index;
						indicator.textContent = String(index + 1).padStart(2, "0");

						// Update active thumb
						thumbs.forEach((thumb, i) => {
							thumb.classList.toggle("active", i === index);
						});
					}
				});
			},
			{ root: container, threshold: 0.5 }
		);

		sections.forEach((section) => observer.observe(section));
	}

	initCaseScroll();
	document.addEventListener("astro:after-swap", initCaseScroll);
</script>
